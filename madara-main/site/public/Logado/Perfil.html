<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../styles/Perfil.css">
    <script src="../js/funcoes.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <title>Document</title>
</head>

<body>
    <div class="social" id="parte1" style="display: block;">
        <h1>sorteio de imagem de perfil</h1>


        Sorteie sua foto de perfil, qual fase do madara voce seria<button onclick="analisar()">Sortear</button>
        <br>
        <br>
        Sua foto sorteada foi : <span id="foto_sorteada"></span>
        <div class="container">
            <ul>
                <li><a href="#img1"> <img src="../Assets/madara-kid.png" class="foto"></a></li>
                <li><a href="#img2"> <img src="../Assets/madara-edo.png" class="foto"></a></li>
                <li><a href="#img3"> <img src="../Assets/madara-caolho.jpg" class="foto"></a></li>
                <li><a href="#img4"> <img src="../Assets/morte.jpg" class="foto"></a></li>
                <li><a href="#img5"> <img src="../Assets/rinnegan.jpeg" class="foto"></a></li>
                <li><a href="#img6"> <img src="../Assets/LOUCO.png" class="foto"></a></li>
                <li><a href="#img7"> <img src="../Assets/madara-folha.jpg" class="foto"></a></li>
                <li><a href="#img8"> <img src="../Assets/madara-guerra.jpg" class="foto"></a></li>
                <li><a href="#img9"> <img src="../Assets/só-madara.jpg" class="foto"></a></li>
            </ul>
        </div>
    </div>

    <div class="banner">
        <div class="hello">
            <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
        </div>

        <div class="dashboard">
            <div class="btns-dash">
                <!-- O gráfico é chamado de acordo com o id (fk_aquario) do banco  -->
                <button class="grafico btn-pink" onclick="obterDadosFoto(1)">Pontos-Quiz</button>
            </div>
            <div>
                <h3 class="tituloGraficos">
                    <span id="tituloAquario">pontuação do quiz</span>
                </h3>
            </div>
            <div class="graph">
                <canvas id="myChart"></canvas>
            </div>
            <div class="avisoCaptura">
                <p id="avisoCaptura" style="color: black"></p>
            </div>
        </div>
    </div>
    <div class="social2" id="parte2" style="display: none;">
       
    </div>



</body>

</html>
<script>
    window.onload = obterDadosFoto(1);

    a_usuario.innerHTML = sessionStorage.NOME_USUARIO

    if (sessionStorage.FOTO_USUARIO != 'NULL') {
    } else {
        parte1.style.display = 'none';
        parte2.style.display = 'block';
    }


    var linkFoto = ''
    function analisar() {

        var sorteio = (Math.random() * 9);

        if (sorteio.toFixed(0) == 0) {
            linkFoto = 'madara-kid.png'

        } else if (sorteio.toFixed(0) == 1) {
            linkFoto = 'madara-kid.png'

        } else if (sorteio.toFixed(0) == 2) {
            linkFoto = 'madara-edo.png'


        } else if (sorteio.toFixed(0) == 3) {
            linkFoto = 'madara-caolho.jpg'


        } else if (sorteio.toFixed(0) == 4) {
            linkFoto = 'morte.jpg'


        } else if (sorteio.toFixed(0) == 5) {
            linkFoto = 'rinnegan.jpeg'


        } else if (sorteio.toFixed(0) == 6) {
            linkFoto = 'LOUCO.png'


        } else if (sorteio.toFixed(0) == 7) {
            linkFoto = 'madara-folha.jpg'


        } else if (sorteio.toFixed(0) == 8) {
            linkFoto = 'madara-guerra.jpg'


        } else if (sorteio.toFixed(0) == 9) {
            linkFoto = 'só-madara.jpg'

        }
        console.log(linkFoto)
        console.log(sorteio)

        foto_sorteada.innerHTML = `<img src="../Assets/${linkFoto}" alt="foto do sorteio" style="width: 300px;">`
        registrarfoto(linkFoto)

        sessionStorage.FOTO_USUARIO = linkFoto
        setTimeout(() => {
            window.location = "../index.html";
        }, "2000")
    }

        function registrarfoto(linkFoto) {

            var fkusu = sessionStorage.ID_USUARIO;


            // Enviando o valor da nova input
            fetch("/usuarios/registrarfoto", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    // crie um atributo que recebe o valor recuperado aqui
                    // Agora vá para o arquivo routes/usuario.js
                    linkFotoServer: linkFoto,
                    fkusuServer: fkusu
                })

            }).then(function (resposta) {

                resposta.json().then(json => {
                    console.log(json);
                    console.log(JSON.stringify(json));
                })


                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    cardErro.style.display = "block";
    
                    mensagem_erro.innerHTML = "Cadastro realizado com sucesso! Redirecionando para tela de Login...";
    
                    setTimeout(() => {
                     //   window.location = "Login-Madara.html";
                    }, "2000")
    
                    limparFormulario();
                    finalizarAguardar();
                } else {
                    throw ("Houve um erro ao tentar realizar o cadastro!");
    
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });

        }

  


        function obterDadosFoto(idUsuario) {


            fetch(`/medidas/ultimas/${idUsuario}`, { cache: 'no-store' }).then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        resposta.reverse();
    
                        plotarFoto(resposta, idUsuario);
    
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
                .catch(function (error) {
                    console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                });
        }

        function plotarFoto(resposta, idUsuario) {
            console.log('iniciando plotagem do gráfico...');
    
            let labels = [
    
            ];
    
            let dados = {
                labels: labels,
                datasets: [{
                    label: 'Pontos',
                    backgroundColor: 'rgb(0,206,209)',
                    borderColor: 'rgb(199,21,133)',
                    data: [],
                    fill: false,
                    tension: 0.1,
    
                },]
            };
    
            Chart.defaults.color = '#ffff';
    
    
            console.log('----------------------------------------------')
            console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
            console.log(resposta)
            console.log(sessionStorage.NOME_USUARIO)
    
            for (i = 0; i < resposta.length; i++) {
                var registro = resposta[i];
                if(registro.nome == sessionStorage.NOME_USUARIO){
                labels.push(registro.linkFoto);
                dados.datasets[0].data.push(registro.idUsuario);
                sessionStorage.FOTO_USUARIO = (registro.linkFoto)

            }
            }
    
            console.log('----------------------------------------------')
            console.log('O gráfico será plotado com os respectivos valores:')
            console.log('Labels:')
            console.log(labels)
            console.log('Dados:')
            console.log(dados.datasets)
            console.log('----------------------------------------------')
    
            const config = {
                type: 'bar',
                data: dados,
                options: {}
            };
            let myChart = new Chart(
                document.getElementById('myChart'),
                config
           );
            
            b_usuario.innerHTML= sessionStorage.FOTO_USUARIO


            
          //  setTimeout(() => {
            //    window.location = "Login-Madara.html";
            //}, "2000")

         
        }



</script>